// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

model User {
  id        String   @id @default(cuid())
  username  String?  @unique
  createdAt DateTime @default(now())
  
  // å…³è”
  personas  Persona[]
  sessions  Session[]
  
  @@map("users")
}

model Persona {
  id               String   @id @default(cuid())
  name             String
  avatar           String
  tags             String   // JSON array of tags
  description      String?
  systemPrompt     String
  
  // æ–°å¢å­—æ®µ
  tone             String   @default("{\"gentle\":0.5,\"direct\":0.5,\"academic\":0.5,\"healing\":0.5,\"humor\":0.5,\"formal\":0.5}") // JSON object for tone sliders
  styleGuide       String?  // é£æ ¼æŒ‡å—
  dos              String?  // JSON array of dos
  donts            String?  // JSON array of don'ts  
  safetyAdapter    String?  // å®‰å…¨é€‚é…å™¨
  fewShots         String?  // JSON array of few-shot examples
  reactionMap      String   @default("{\"happy\":\"ğŸ˜Š\",\"thinking\":\"ğŸ¤”\",\"surprised\":\"ğŸ˜²\",\"empathetic\":\"ğŸ¥º\",\"warning\":\"âš ï¸\",\"comforting\":\"ğŸ¤—\",\"neutral\":\"ğŸ™‚\"}") // JSON object
  
  // æƒé™å’Œå¯è§æ€§
  isPublic         Boolean  @default(false)
  shareToken       String?  @unique // åˆ†äº«é“¾æ¥çš„token
  
  // å…³è”
  userId           String?
  user             User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  // å…³è”
  versions         PersonaVersion[]
  sessions         Session[]
  messages         Message[]
  metrics          PersonaMetric[]
  
  @@map("personas")
}

model PersonaVersion {
  id               String   @id @default(cuid())
  personaId        String
  version          Int      @default(1)
  
  // ç‰ˆæœ¬åŒ–çš„å­—æ®µ
  name             String
  avatar           String
  tags             String
  description      String?
  systemPrompt     String
  tone             String
  styleGuide       String?
  dos              String?
  donts            String?
  safetyAdapter    String?
  fewShots         String?
  reactionMap      String
  
  // å˜æ›´ä¿¡æ¯
  changeLog        String?  // å˜æ›´è¯´æ˜
  
  createdAt        DateTime @default(now())
  
  // å…³è”
  persona          Persona  @relation(fields: [personaId], references: [id], onDelete: Cascade)
  
  @@unique([personaId, version])
  @@map("persona_versions")
}

model PersonaMetric {
  id                String   @id @default(cuid())
  personaId         String
  
  // ä¸€è‡´æ€§è¯„åˆ†
  adherenceScore    Float?   // 0-1 äººæ ¼ä¸€è‡´æ€§å¾—åˆ†
  
  // ä½¿ç”¨ç»Ÿè®¡
  tokenCount        Int      @default(0)
  wordCount         Int      @default(0)
  emojiCount        Int      @default(0)
  paragraphCount    Int      @default(0)
  responseTime      Float?   // å“åº”æ—¶é—´(ms)
  cost              Float?   // æ¨æ–­æˆæœ¬
  
  // è¯­æ°”åˆ†æ
  sentimentScore    Float?   // æƒ…æ„Ÿå¾—åˆ†
  formalityScore    Float?   // æ­£å¼åº¦
  creativityScore   Float?   // åˆ›é€ æ€§
  
  createdAt         DateTime @default(now())
  
  // å…³è”
  persona           Persona  @relation(fields: [personaId], references: [id], onDelete: Cascade)
  
  @@map("persona_metrics")
}

model Session {
  id          String   @id @default(cuid())
  userId      String?
  personaId   String
  title       String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // å…³è”
  user        User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  persona     Persona  @relation(fields: [personaId], references: [id], onDelete: Cascade)
  messages    Message[]
  
  @@map("sessions")
}

model Message {
  id         String      @id @default(cuid())
  sessionId  String
  personaId  String
  content    String
  role       MessageRole
  emotion    String?
  
  // æ–°å¢å­—æ®µç”¨äºA/Bæµ‹è¯•
  reactionTag String?    // è¡¨æƒ…æ ‡ç­¾
  metadata    String?    // JSON metadata
  
  createdAt  DateTime    @default(now())
  
  // å…³è”
  session    Session     @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  persona    Persona     @relation(fields: [personaId], references: [id], onDelete: Cascade)
  
  @@map("messages")
}

model Reaction {
  id          String   @id @default(cuid())
  emotion     String   // æƒ…ç»ªç±»å‹
  emoji       String   // å¯¹åº”è¡¨æƒ…
  description String?  // æè¿°
  
  createdAt   DateTime @default(now())
  
  @@map("reactions")
}

enum MessageRole {
  user
  assistant
}
